<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Iptables setup — iaroki blog</title>
	<meta name="description" content="Title: Iptables setup; Date: 2017-01-11; Author: iaroki">
	<meta name="author" content="iaroki">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="/theme/html5.js"></script>
		<![endif]-->
	<link href="/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="/theme/css/local.css" rel="stylesheet">
	<link href="/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="/">iaroki blog</a>
			<br>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Iptables setup</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">iaroki</h4>
		</span>
		<time datetime="2017-01-11T13:02:00+02:00" itemprop="datePublished">Wed 11 January 2017</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="/category/linux.html" rel="category">Linux</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="/tag/linux.html" rel="tag">linux</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/network.html" rel="tag">network</a>
		</span>
		<span itemprop="keywords">
			<a href="/tag/iptables.html" rel="tag">iptables</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>With iptables, several different packet matching tables are defined and each table can contain a number of built-in chains as well as some chains defined by the user. The chains are actually lists of rules that match set of packets and each rule specifies what to do with the matched packet.</p>
<p>The default table is the <code>filter</code> table and it contains the built-in chains INPUT, FORWARD, and OUTPUT. The INPUT chain is used for packets destined to local sockets, the FORWARD chain is used for packets being routed through the box while the OUTPUT chain is used for locally-generated packets.</p>
<p>Connect to your server via SSH and list the rules defined in a specific chain using the following syntax:</p>
<div class="highlight"><pre><span></span>sudo iptables -L CHAIN
</pre></div>


<p>Replace CHAIN with one of the built-in chains to see the defined rules. If no chain is selected, all chains will be listed in the output.</p>
<div class="highlight"><pre><span></span>sudo iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
</pre></div>


<p>The firewall rules specify what to do with a certain packet if it matches certain criteria and in case the packet doesn’t match the criteria, the next firewall rule defined in the chain will be examined. This is a very important thing to know when defining the firewall rules because you can easily lock yourself out of your server if you define the rule which accepts packets from your local IP address after the blocking rule.</p>
<p>The targets you can use for the firewall rules are ACCEPT, DROP, QUEUE and RETURN. ACCEPT will let the packet through, DROP will drop the packet, QUEUE will pass the packet to the userspace while RETURN will stop the packet traversing of the current chain and will resume at the next rule in the previous chain. The default chain policy will define what to do with a packet if it doesn’t match certain firewall rule. As you can see in the output of the first command, the default policy for all built-in chains is set to ACCEPT. ACCEPT will let the packet go through so basically there is no protection.</p>
<p>Before adding any specific rules, add the following one:</p>
<div class="highlight"><pre><span></span>sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
</pre></div>


<p>This will prevent the connections that are already established to be dropped and your current SSH session will remain active.</p>
<p>Next, add rules to allow traffic on your loopback interface:</p>
<div class="highlight"><pre><span></span>sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT
</pre></div>


<p>Next, allow access to your server via SSH for your local IP address so only you can access the server:</p>
<div class="highlight"><pre><span></span>sudo iptables -A INPUT -s 111.111.111.111 -p tcp --dport 22 -j ACCEPT
</pre></div>


<p>Where <code>111.111.111.111</code> is your local IP address and <code>2</code> is the listening port of your SSH daemon. In case your local IP address changes dynamically it is best to omit the <code>-s 111.111.111.111</code> part and use a different method to protect the SSH service from unwanted traffic.</p>
<div class="highlight"><pre><span></span>sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
</pre></div>


<p>Next, allow access to your important services like HTTP/HTTPS server:</p>
<div class="highlight"><pre><span></span>sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
</pre></div>


<p>Now, list the current rules and check if everything is OK. For detailed output you can use the following command:</p>
<div class="highlight"><pre><span></span>sudo iptables -nvL
</pre></div>


<p>If you have other services that you want to allow access to it is best to do that now. Once you are done, you can set the default policy for the INPUT built-in chain to DROP.</p>
<div class="highlight"><pre><span></span>sudo iptables -P INPUT DROP
</pre></div>


<p>This will drop any packet that doesn’t match the firewall rules criteria. The final output should be similar to the following one:</p>
<div class="highlight"><pre><span></span>Chain INPUT (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
    0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0
    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22
    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     all  --  *      lo      0.0.0.0/0            0.0.0.0/0
</pre></div>


<p>However, if you now restart the server you will lose all the firewall rules you defined so it is really important to make the rules permanent.</p>
<p>In case you are using an Ubuntu you need to install an additional package for that purpose. Go ahead and install the required package using the following command:</p>
<div class="highlight"><pre><span></span>sudo apt-get install iptables-persistent
</pre></div>


<p>On Ubutnu 14.04 you can save and reload the firewall rules using the commands below:</p>
<div class="highlight"><pre><span></span>sudo /etc/init.d/iptables-persistent save
sudo /etc/init.d/iptables-persistent reload
</pre></div>


<p>On Ubuntu 16.04 use the following commands instead:</p>
<div class="highlight"><pre><span></span>sudo netfilter-persistent save
sudo netfilter-persistent reload
</pre></div>


<p>If you are using a CentOS you can save the firewall rules using the command below:</p>
<div class="highlight"><pre><span></span>service iptables save
</pre></div></div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="">iaroki blog</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://github.com">Github</a></li>
							<li><a href="https://facebook.com">Facebook</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="/category/docker.html">Docker (3)</a></li>
							<li><a href="/category/git.html">Git (2)</a></li>
							<li><a href="/category/linux.html">Linux (23)</a></li>
							<li><a href="/category/markdown.html">Markdown (2)</a></li>
							<li><a href="/category/other.html">Other (1)</a></li>
							<li><a href="/category/python.html">Python (1)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://getpelican.com/">Pelican</a></li>
							<li><a href="http://python.org/">Python.org</a></li>
							<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; iaroki 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
</body>
</html>